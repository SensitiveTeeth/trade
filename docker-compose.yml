version: '3.8'

services:
  futuopend:
    image: futuopend:latest
    build:
      context: ./futuopend
      dockerfile: Dockerfile
    container_name: futuopend
    ports:
      - "11111:11111"  # Trading API
      - "11112:11112"  # Quote API
    volumes:
      - ./futuopend/FutuOpenD.xml:/app/FutuOpenD.xml
    stdin_open: true
    tty: true
    restart: unless-stopped
    networks:
      - trading-net
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "11111"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  trading:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: trading
    depends_on:
      futuopend:
        condition: service_healthy
    env_file:
      - .env
    environment:
      # Use localhost since we share network namespace with futuopend
      - FUTU_HOST=127.0.0.1
      - FUTU_PORT=11111
      - TZ=Asia/Hong_Kong
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    restart: unless-stopped
    # Share network namespace with futuopend to avoid cross-network encryption requirement
    network_mode: "service:futuopend"

